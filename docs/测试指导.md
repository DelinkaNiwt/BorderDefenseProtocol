---
标题：RimTrion微内核游戏内测试指导
版本号: v1.0
更新日期: 2026-02-17
最后修改者: Claude Opus 4.6
标签: [文档][用户未确认][已完成][未锁定]
摘要: RimTrion微内核（Trion能量系统）的游戏内测试指导。覆盖部署步骤、Dev Mode测试流程、6个测试用例（模组加载/CompTrion挂载/Stat聚合/Need恢复/耗尽效果/存档兼容），以及常见问题排查。
---

# RimTrion微内核游戏内测试指导

## 前置说明

RimWorld模组运行在Unity引擎内部，无法脱离游戏做传统单元测试。
本文档提供游戏内Dev Mode测试方案，验证微内核各组件行为是否符合6.1详细设计。

---

## 1. 部署

### 1.1 方式A：符号链接（推荐）

在**管理员权限**的命令提示符中执行：

```cmd
mklink /D "C:\NiwtGames\Steam\steamapps\common\RimWorld\Mods\RimTrion" "C:\NiwtDatas\Projects\RimworldModStudio\模组工程\RimTrion"
```

优点：改代码后重编译即生效，无需手动复制。

### 1.2 方式B：手动复制

将 `模组工程\RimTrion\` 复制到 `RimWorld\Mods\` 下。
每次重编译后需重新复制 `1.6\Assemblies\RimTrion.dll`。

### 1.3 启用模组

1. 启动RimWorld
2. 主菜单 → Mods → 找到 "RimTrion" → 勾选启用
3. 重启游戏

### 1.4 编译命令

```cmd
cd C:\NiwtDatas\Projects\RimworldModStudio\模组工程\RimTrion\Source\RimTrion
dotnet build RimTrion.csproj
```

---

## 2. 开启Dev Mode

Options → 勾选 "Development mode"

开启后屏幕顶部出现调试工具栏，包含以下常用按钮：
- 🐛 Debug actions menu（调试操作菜单）
- 🔍 Inspector（检查器）
- 📋 Debug log（调试日志）

---

## 3. 测试用例

### TC-1：模组加载验证

**目的**：确认模组正确加载，无XML/C#错误。

**步骤**：
1. 启用模组并重启游戏
2. 打开 Debug Log（调试工具栏日志按钮）
3. 搜索 "RimTrion" 或 "error"

**预期**：
- 无红色错误信息
- 无 "Could not resolve" 或 "Missing type" 警告
- 黄色警告 "Could not find icon at UI/Icons/Genes/Gene_TrionGland" 是正常的（暂无图标）

**失败排查**：
- "Missing type RimTrion.Core.xxx" → DLL未部署，检查 `1.6/Assemblies/RimTrion.dll`
- "Could not resolve def xxx" → XML中defName拼写错误
- "Patch operation failed" → XPath路径错误，检查 `Patches/Patch_HumanlikePawn.xml`

---

### TC-2：CompTrion挂载与初始数据

**目的**：确认CompTrion通过Patch正确挂载到人类Pawn。

**步骤**：
1. 新建殖民地（Dev Mode快速开始）
2. 选中任意殖民者
3. 调试工具栏 → Inspector（放大镜图标）
4. 展开选中的Pawn，在底部信息栏查看是否有 "Trion: 0.0 / 0.0"

**预期**：
- 所有人类Pawn都有CompTrion（通过Patch注入）
- 没有Trion腺体基因的Pawn：max=0, cur=0（惰性状态）
- Inspector底部应显示 "Trion: 0.0 / 0.0"

---

### TC-3：基因添加与Stat聚合

**目的**：验证添加Trion腺体基因后，Stat正确聚合，CompTrion.max更新。

**步骤**：
1. 选中一个殖民者
2. 调试工具栏 → Debug actions → 搜索 "Add gene"
3. 选择 "RimTrion_Gene_TrionGland"
4. 再次用Inspector查看该Pawn

**预期**：
- CompTrion.max 变为 70（GeneDef中TrionCapacity的statOffsets值）
- CompTrion.cur 变为 70（startPercent=1.0，满值）
- Inspector底部显示 "Trion: 70.0 / 70.0"
- Pawn需求面板出现 "Trion" 需求条（由causesNeed触发）
- Pawn的Stat面板中出现：
  - Trion容量: 70
  - Trion输出功率: 5
  - Trion恢复速率: 50

**验证Stat聚合**（可选，更精确）：
1. 调试工具栏 → Debug actions → 搜索 "Log stat"
2. 选择 "RimTrion_TrionCapacity"，点击该Pawn
3. Debug Log中会显示Stat的聚合明细

---

### TC-4：Need_Trion恢复机制

**目的**：验证Trion能量的自然恢复。

**步骤**：
1. 确保Pawn已有Trion腺体基因（TC-3）
2. 调试工具栏 → Debug actions → 搜索 "Set need level"
3. 将Trion需求设为较低值（如0.3，即30%）
   - 注意：由于Need_Trion的CurLevel setter是空操作，
     这个方法可能不生效。备选方案见下方。
4. **备选方案**：通过Debug actions → "Execute method" 或直接等待观察

**备选消耗测试方法**：
1. 用Debug actions搜索 "Damage pawn" 或其他会触发Trion消耗的操作
2. 由于当前只有微内核，没有消耗Trion的模块，
   可以临时在代码中添加一个Debug Gizmo按钮来手动消耗Trion

**简易验证**：
- 观察需求面板中Trion条是否显示为满（绿色）
- 如果Pawn有基因且CompTrion.max > 0，需求条应该是满的
- 恢复速率=50/天，即每150 ticks恢复 50×(150/60000)=0.125点

---

### TC-5：Trion耗尽效果

**目的**：验证Trion低于阈值时的负面Hediff。

**前置**：需要一种方式将Trion降到30%以下。

**方法**：在CompTrion中临时添加一个Debug Gizmo（推荐）：

在 `CompTrion.cs` 中临时添加以下方法（测试完后删除）：

```csharp
public override IEnumerable<Gizmo> CompGetGizmosExtra()
{
    foreach (var g in base.CompGetGizmosExtra())
        yield return g;

    // Debug: 消耗10点Trion
    yield return new Command_Action
    {
        defaultLabel = "DEV: -10 Trion",
        action = () => { cur = Mathf.Max(0f, cur - 10f); }
    };
    // Debug: 恢复到满
    yield return new Command_Action
    {
        defaultLabel = "DEV: Fill Trion",
        action = () => { cur = max; }
    };
}
```

**步骤**：
1. 添加Debug Gizmo，重编译，重启游戏
2. 选中有Trion基因的Pawn
3. 反复点击 "DEV: -10 Trion" 将Trion降到30%以下
4. 观察Pawn的Health面板

**预期**：
- Trion < 30%：出现 "Trion不足" Hediff，移动速度-10%
- Trion < 15%：变为 "Trion严重不足"，移动-20%，操作-10%
- Trion < 3%：变为 "Trion枯竭"，意识-10%，移动-30%
- 点击 "DEV: Fill Trion" 恢复后，Hediff应在150 ticks内消失

---

### TC-6：存档兼容性

**目的**：验证存档/读档后Trion数据正确保持。

**步骤**：
1. 确保有一个带Trion基因的Pawn，且Trion不是满值
2. 保存游戏
3. 退出到主菜单
4. 重新加载存档
5. 检查该Pawn的Trion值

**预期**：
- cur、max、allocated、frozen 四个值与存档前一致
- 需求面板中Trion条位置不变
- 无红色错误日志

---

## 4. 已知限制

| 限制 | 原因 | 影响 |
|------|------|------|
| 无基因图标 | 未制作贴图 | 基因面板显示默认图标，不影响功能 |
| 无法通过Need面板直接调整Trion | CurLevel setter是空操作（设计如此） | 需要通过Debug Gizmo或代码测试 |
| 没有消耗Trion的游戏内途径 | 触发器/战斗等模块尚未实现 | 需要临时Debug Gizmo辅助测试 |

---

## 5. 测试检查清单

| # | 测试项 | 通过条件 | 状态 |
|---|--------|---------|------|
| 1 | 模组加载 | 无红色错误 | ☐ |
| 2 | CompTrion挂载 | 所有人类Pawn有CompTrion | ☐ |
| 3 | 基因+Stat聚合 | 添加基因后max=70 | ☐ |
| 4 | Need显示 | 需求面板出现Trion条 | ☐ |
| 5 | 恢复机制 | Trion随时间恢复 | ☐ |
| 6 | 耗尽效果 | 低于30%出现负面Hediff | ☐ |
| 7 | 存档兼容 | 读档后数据一致 | ☐ |

---

## 历史修改记录

| 版本 | 日期 | 修改摘要 | 签名 |
|------|------|---------|------|
| v1.0 | 2026-02-17 | 创建文档。覆盖部署、Dev Mode、6个测试用例（含Debug Gizmo辅助方案）、已知限制、检查清单 | Claude Opus 4.6 |
