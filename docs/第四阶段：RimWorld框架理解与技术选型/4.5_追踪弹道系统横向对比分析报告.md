---
标题：追踪弹道系统横向对比分析报告
版本号: v1.0
更新日期: 2026-02-27
最后修改者: Claude Sonnet 4.6
标签: [文档][用户未确认][已完成][未锁定]
摘要: 对比 BDP 追踪弹道模块与机械族全面战争、米莉拉帝国、天工铸造3三个社区模组的追踪/智能弹道实现机制，从技术设计、视觉体验、游戏设计三个维度进行综合评估，并提出 BDP 可借鉴的优化方向。
---

# 追踪弹道系统横向对比分析报告

## 一、背景与目的

BDP 模组的追踪弹道模块（`TrackingModule`）已完成基础实现。本报告通过对比三个具有代表性的社区模组，评估 BDP 当前实现的优劣，并识别可借鉴的设计思路。

**参与对比的系统：**

| 模组 | 核心类 | 弹道类型 | 命名空间 |
|------|--------|----------|----------|
| **BDP（本模组）** | `TrackingModule` + `Bullet_BDP` | 角速度限幅追踪 | `BDP.Trigger` |
| **机械族全面战争** | `Projectile_BezierTrackingMissile` | 贝塞尔曲线追踪导弹 | `TY_Mora_Gene_B.com` |
| **米莉拉帝国** | `MI_PointDefnseProjectile` | 直接覆盖终点（点防御） | `MiliraImperium` |
| **天工铸造3** | `Projectile_PoiBullet` / `Projectile_Split` | 贝塞尔 + 一次性命运判定 | `TOT_DLL_test` |

---

## 二、技术设计维度

### 2.1 架构模式对比

```
BDP（管线-组合模式）
┌─────────────────────────────────────────────────────┐
│  Bullet_BDP（薄壳宿主）                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ │
│  │Tracking  │ │ Guided   │ │  Trail   │ │Impact  │ │
│  │Module    │ │ Module   │ │  Module  │ │Module  │ │
│  └──────────┘ └──────────┘ └──────────┘ └────────┘ │
│  管线接口：PathResolver / TickObserver / Arrival...  │
└─────────────────────────────────────────────────────┘

机械族全面战争（单体继承模式）
┌─────────────────────────────────────────────────────┐
│  Projectile_BezierTrackingMissile（742行）           │
│  ├─ 贝塞尔计算（内嵌，7种弹道类型枚举）              │
│  ├─ 目标管理（内嵌）                                 │
│  ├─ 粒子特效（内嵌）                                 │
│  └─ 序列化（内嵌）                                   │
└─────────────────────────────────────────────────────┘

天工铸造3（单体 + ThingComp 扩展）
┌─────────────────────────────────────────────────────┐
│  Projectile_PoiBullet（251行）                       │
│  ├─ 命运判定（内嵌）                                 │
│  ├─ 贝塞尔视觉（内嵌，二次曲线）                     │
│  └─ CompSmartWeapon（距离衰减，外挂 Comp）           │
└─────────────────────────────────────────────────────┘

米莉拉帝国（单体 + 外部建筑依赖）
┌─────────────────────────────────────────────────────┐
│  MI_PointDefnseProjectile                           │
│  └─ 目标搜索完全外包给 MI_Building_SpinTurretGun    │
└─────────────────────────────────────────────────────┘
```

**结论：** BDP 的管线-组合架构是四者中唯一实现了关注点分离的设计，追踪逻辑、视觉效果、命中处理各自独立，可单独替换或扩展。其余三者均为单体继承，功能耦合度高。

---

### 2.2 追踪算法核心对比

#### BDP — 角速度模型

每 tick 在 `ResolvePath()` 中执行：

1. 计算当前位置到目标的期望角度 `desiredAngle`
2. 计算角度差 `angleDiff = DeltaAngle(currentAngle, desiredAngle)`
3. 按模式更新角度：
   - **Simple 模式**：`currentAngle += Clamp(angleDiff, -maxTurnRate, maxTurnRate)`
   - **Smooth 模式**：角加速度 + 阻尼衰减（`angularVelocity *= damping`）
4. 调用 `RedirectFlightTracking()` 重设 `origin/destination/ticksToImpact`

**远近距离分策略：**
- 远距离（`dist > speed*3`）：固定 60 tick，精确速度，消除 CeilToInt 取整误差
- 近距离（`dist ≤ speed*3`）：用实际距离，1~3 tick 内自然归零触发 Impact

#### 机械族全面战争 — 贝塞尔控制点重算

每 tick 在 `RecalculateCurve()` 中执行：

1. 读取目标当前位置，并做**速度外推预测**：`predictedPos = targetPos + velocity * 3f`
2. 计算当前飞行方向与目标方向的夹角
3. 按飞行阶段调整最大转角（中段×1.5，末段×2.0）
4. 用 `Quaternion.AngleAxis` 旋转当前方向
5. 重算贝塞尔控制点 p1/p2，下一帧 `BezierPoint(t)` 自然跟随新曲线

支持 7 种弹道类型：`BezierCurve / Parabolic / Sinusoidal / Spiral / Linear / SmoothStep / Lemniscate`

#### 天工铸造3 — 命运判定 + 条件追踪

这是四者中最独特的设计，核心思路是**把"准不准"的问题从弹道层面提前到发射层面**：

```
发射后第 1 tick：
  CalHit = Rand.Chance(Hitchance())  ← 一次性掷骰，此后不再变化

每 tick：
  if (CalHit)
    destination = intendedTarget.Thing.DrawPos  ← 追踪真实目标
  else
    intendedTarget = 目标周围2格随机格           ← 飞向偏移位置
```

**命中率公式（智力技能驱动）：**

```
t = Clamp01(Intellectual / 20)
smooth = 3t² - 2t³          ← SmoothStep 曲线
hitchance = 0.33 + 0.62 * smooth
```

| 智力等级 | 命中率 |
|---------|--------|
| 0 | 33% |
| 8 | 55% |
| 10 | 64% |
| 14 | 82% |
| 20 | 95% |

SmoothStep 曲线让低智力段提升缓慢、中段加速、高段趋于平缓，比线性更符合"熟练度曲线"的直觉。

#### 米莉拉帝国 — 直接覆盖终点

```csharp
// 每 tick，无任何转向限制
destination = intendedTarget.CenterVector3;
```

无转向物理模型，瞬间重定向，仅作为点防御系统的附属功能使用。

---

### 2.3 转向物理模型对比

| 维度 | BDP | 机械族全面战争 | 天工铸造3 | 米莉拉帝国 |
|------|:---:|:---:|:---:|:---:|
| 转向有惯性 | ✅ Smooth 模式角加速度 | ✅ 方向反转时×0.5 防抖 | ❌ | ❌ |
| 最大转角限制 | ✅ `maxTurnRate` | ✅ `maxTurnAngle` | ❌ | ❌ |
| 飞行阶段差异化转速 | ❌ 全程统一 | ✅ 中段×1.5 末段×2.0 | ❌ | ❌ |
| 目标位置预测 | ❌ 追当前位置 | ✅ 速度外推×3 tick | ❌ | ❌ |
| 物理真实感 | 中 | 高 | 低 | 极低 |

---

### 2.4 目标管理能力对比

| 能力 | BDP | 机械族全面战争 | 天工铸造3 | 米莉拉帝国 |
|------|:---:|:---:|:---:|:---:|
| 自主搜索新目标 | ✅ `TargetSearcher` | ✅ LINQ 扫描 | ❌ | ❌ 依赖建筑 |
| 目标切换 | ✅ 角度超限触发 | ✅ 概率切换 `targetSwitchChance` | ❌ | ❌ |
| 丢失超时自毁 | ✅ 60 tick | ❌ | ❌ | ❌ |
| 幽灵伤害防护 | ✅ `TrackingExpired → Impact(null)` | ❌ | ❌ | ❌ |
| 目标有效性校验 | ✅ 死亡/倒地/离图 | ✅ 死亡/销毁 | ✅ 死亡/倒地 | ✅ 死亡/销毁 |

**幽灵伤害问题说明：** 原版 `ImpactSomething()` 第一行会无视距离直接命中 `usedTarget`，导致子弹飞出 10+ 格后仍造成伤害。BDP 通过 `TrackingExpired` 标志在追踪丢失时改为 `Impact(null)` 打地面，是四者中唯一处理此问题的实现。

---

### 2.5 序列化完整性

| 模组 | 序列化字段 | 存档安全性 |
|------|-----------|-----------|
| BDP | 8 个（角度/角速度/飞行 tick/初始距离/丢失计数等） | ✅ 完整 |
| 机械族全面战争 | 20+ 个（含贝塞尔控制点 p0~p3） | ✅ 完整 |
| 天工铸造3 | ❌ 无 `ExposeData` | ⚠️ 存档后 `CalHit` 状态丢失，重载后重新掷骰 |
| 米莉拉帝国 | ❌ 无 `ExposeData` | ⚠️ 存档后追踪状态丢失 |

---

### 2.6 鲁棒性与防御性编程

**BDP：**
- ✅ 超时自毁（`maxFlyingTicks`）
- ✅ 丢失追踪 60 tick 自毁，防止残留子弹触发 vanilla 拦截
- ✅ `TrackingExpired` 防幽灵伤害
- ✅ `finalApproach` 防止近距离反复重定向
- ✅ `postLaunchInitDone` 修复 `SpawnSetup` 时序问题（`intendedTarget` 在 `SpawnSetup` 时尚未赋值）

**机械族全面战争：**
- ⚠️ 大量 `try-catch` 掩盖异常，出错时静默降级为线性弹道
- ❌ 无超时自毁
- ❌ 无幽灵伤害防护
- ✅ NaN/Infinity 检查

**天工铸造3：**
- ✅ 逻辑简单，出错面小
- ❌ 无存档支持

**米莉拉帝国：**
- ⚠️ 用反射调用私有方法 `CheckForFreeInterceptBetween`，版本兼容性存疑
- ❌ 无存档支持

---

## 三、视觉体验维度

### 3.1 弹道形状对比

```
BDP（角速度追踪）
  发射点 ──────────────────────────────► 目标
                    ↑ 转向有限幅，弯曲自然
  特点：平面内弧线追踪，无高度感，像导弹在地面滑行

机械族全面战争（贝塞尔曲线）
  发射点
    \
     \  ← 高度 25~40 格（抛物线顶点）
      \
       ──────────────────────────────► 目标
  特点：有明显抛物弧度，像真实导弹从高空俯冲

天工铸造3（二次贝塞尔 + 随机偏移）
  发射点 ──[轻微弯曲]──────────────────► 目标（命中）
  发射点 ──[轻微弯曲]──────────────────► 偏移格（偏飞）
  特点：微弯曲线，不像导弹，更像"智能子弹"

米莉拉帝国（直线）
  发射点 ──────────────────────────────► 目标
  特点：完全直线，无视觉特色
```

### 3.2 视觉反馈系统对比

| 特性 | BDP | 机械族全面战争 | 天工铸造3 | 米莉拉帝国 |
|------|:---:|:---:|:---:|:---:|
| 弹道朝向旋转 | ❌ | ✅ `Quaternion.LookRotation` | ✅ `Quaternion.LookRotation` | ❌ |
| 拖尾特效 | ✅ TrailModule | ✅ FireGlow/MicroSparks | ✅ `CMC_GunTail_Blue` 连线 | ✅ Smoke |
| 地面阴影 | ❌ | ✅ `shadowMaterial` | ❌ | ❌ |
| 锁定准星 Mote | ❌ | ❌ | ✅ `CMC_Mote_SWTargetLocked` | ❌ |
| 命中/偏飞视觉区分 | ❌ | ❌ | ✅ 飞向不同位置 | ❌ |
| 高度感 | ❌ | ✅ 25~40 格高度偏移 | ❌ | ❌ |

### 3.3 视觉体验综合评分

```
BDP
  弹道形状    ████████░░  40%  平面弧线，无高度感
  朝向旋转    ░░░░░░░░░░   0%  无
  特效丰富度  ████████░░  40%  TrailModule 存在但与追踪解耦
  反馈清晰度  ████████░░  40%  无锁定/偏飞视觉区分
  综合视觉    ████░░░░░░  30%

机械族全面战争
  弹道形状    ██████████ 100%  7 种弹道，高度感强
  朝向旋转    ██████████ 100%  LookRotation，导弹感强
  特效丰富度  ████████░░  80%  阴影+拖尾+粒子
  反馈清晰度  ████████░░  40%  无命中/偏飞区分
  综合视觉    ████████░░  80%

天工铸造3
  弹道形状    ██████░░░░  60%  微弯曲线，有朝向
  朝向旋转    ██████████ 100%  LookRotation
  特效丰富度  ████████░░  80%  蓝色连线拖尾+锁定准星
  反馈清晰度  ██████████ 100%  锁定准星+命中/偏飞视觉区分
  综合视觉    ████████░░  85%

米莉拉帝国
  弹道形状    ██░░░░░░░░  20%  直线
  朝向旋转    ░░░░░░░░░░   0%  无
  特效丰富度  ████░░░░░░  40%  Smoke
  反馈清晰度  ██░░░░░░░░  20%  无
  综合视觉    ██░░░░░░░░  20%
```

---

## 四、游戏设计维度

### 4.1 技能/属性关联

只有天工铸造3实现了技能关联，且选择**智力**而非射击技能，这是一个刻意的设计决策：

> 智能武器 = 武器本身在瞄准，不需要射击技巧，但需要操作者足够聪明来"驾驭"武器的 AI 系统。

这让智力高的殖民者（研究员/医生）也能成为有效战斗单位，拓宽了角色定位。

### 4.2 距离衰减（天工铸造3 独有）

`CompSmartWeapon` 提供两条衰减曲线：

```
伤害衰减（平方曲线）：
  dmgMult = m + (1-m) * (dist-d0)² / dist²

穿甲衰减（立方曲线，衰减更快）：
  penMult = Clamp((dist-d0)³ / dist³, minPen, 1)
```

穿甲比伤害衰减更快，意味着远距离时子弹虽然还有伤害，但穿甲能力大幅下降——这是一个精心设计的平衡机制，防止智能武器在远距离无脑碾压重甲目标。

### 4.3 玩家信息透明度

| 模组 | 玩家能看到什么 | 信息透明度 |
|------|--------------|-----------|
| BDP | 子弹在追目标 | 中（知道在追，不知道会不会追上） |
| 机械族全面战争 | 导弹飞行弧线 | 低（看不出追踪状态） |
| 天工铸造3 | 锁定准星 + 子弹是否飞向目标 | 高（一眼看出命中/偏飞） |
| 米莉拉帝国 | 子弹直线飞 | 低 |

---

## 五、综合评分

| 维度（权重） | BDP | 机械族全面战争 | 天工铸造3 | 米莉拉帝国 |
|------------|:---:|:---:|:---:|:---:|
| 技术正确性（30%） | **95** | 75 | 70 | 40 |
| 架构可扩展性（20%） | **95** | 40 | 50 | 40 |
| 鲁棒性（20%） | **90** | 60 | 50 | 40 |
| 视觉体验（15%） | 30 | **80** | **85** | 20 |
| 游戏设计深度（10%） | 60 | 65 | **85** | 50 |
| 代码可维护性（5%） | **90** | 50 | 70 | 60 |
| **加权综合** | **80** | **63** | **67** | **41** |

---

## 六、各模组核心设计哲学

| 模组 | 设计哲学 |
|------|---------|
| **BDP** | "弹道是可组合的管线，追踪只是其中一个模块" → 工程师思维，优先架构正确性和可扩展性 |
| **机械族全面战争** | "导弹应该看起来像导弹" → 视觉优先，7 种弹道类型是核心卖点 |
| **天工铸造3** | "智能武器的'智能'应体现在命中判定上，而不是弹道上" → 游戏设计优先，用最简单的技术实现最清晰的游戏语义 |
| **米莉拉帝国** | "能用就行" → 功能导向，追踪只是点防御系统的附属功能 |

---

## 七、BDP 可借鉴的优化方向

BDP 在技术层面已是四者中最优，短板集中在**视觉表现**和**游戏设计深度**。以下优化均可通过新增模块实现，不需要改动现有追踪逻辑。

### 7.1 弹道朝向旋转（来自机械族全面战争 / 天工铸造3）

**现状：** BDP 的 `DrawPos` 不含朝向信息，子弹贴图不随飞行方向旋转。

**方案：** 新增 `RotationPositionModifier` 模块，在 `ModifyPosition()` 中记录上一帧位置，用 `Quaternion.LookRotation` 计算朝向，写入 `DrawAt` 的旋转参数。

**收益：** 视觉提升显著，实现难度低。

### 7.2 锁定准星 Mote（来自天工铸造3）

**现状：** 玩家无法直观看出子弹是否正在追踪目标。

**方案：** 在 `TrackingModule.ResolvePath()` 中，当 `IsTracking = true` 时，用 `MoteMaker.MakeAttachedOverlay` 在目标身上显示锁定准星，追踪丢失时销毁。

**收益：** 玩家反馈清晰度大幅提升，实现难度低。

### 7.3 飞行阶段差异化转速（来自机械族全面战争）

**现状：** BDP 全程使用统一转速，导弹末端机动感不足。

**方案：** 在 `BDPTrackingConfig` 中增加 `finalPhaseTurnMultiplier` 配置项，在 `ResolvePath()` 中根据 `distToTarget / initialDistance` 判断飞行阶段，末段乘以倍率。

**收益：** 物理感提升，实现难度低。

### 7.4 目标位置预测（来自机械族全面战争）

**现状：** BDP 追踪目标当前位置，对高速移动目标存在"追不上"的情况。

**方案：** 在 `BDPTrackingConfig` 中增加可选的 `enablePrediction` 和 `predictionTicks` 配置项，在 `ResolvePath()` 中对移动中的 Pawn 做速度外推：

```csharp
// 伪代码，仅供参考
if (cfg.enablePrediction && target is Pawn p && p.pather.Moving)
{
    Vector3 vel = targetPos - lastTargetPos;
    targetPos += vel * cfg.predictionTicks;
}
```

**收益：** 命中率提升，实现难度中等（需记录上一帧目标位置）。

### 7.5 距离衰减 Comp（来自天工铸造3）

**现状：** BDP 追踪弹无距离衰减，远距离命中与近距离命中效果相同。

**方案：** 参考 `CompSmartWeapon` 的平方/立方衰减曲线，实现为独立的 `IBDPImpactHandler` 模块，在 `HandleImpact()` 中修改 `DamageInfo` 的伤害和穿甲值。

**收益：** 平衡性提升，防止追踪弹在远距离无脑碾压，实现难度中等。

---

## 八、总结

BDP 的追踪弹道模块在**架构设计**、**技术正确性**和**鲁棒性**上是四者中最优的，特别是管线化设计和幽灵伤害防护是其他模组没有的。

主要短板在**视觉表现**（无高度感、无朝向旋转、无锁定准星）和**游戏设计深度**（无技能关联、无距离衰减）。这两个方向的优化都可以通过新增模块来补充，不需要改动现有追踪逻辑，符合 BDP 的最简原则。

优先级建议：**弹道朝向旋转 > 锁定准星 Mote > 飞行阶段差异化转速 > 目标位置预测 > 距离衰减**。

---

## 历史修改记录

| 版本 | 日期 | 修改摘要 | 签名 |
|------|------|---------|------|
| v1.0 | 2026-02-27 | 初始生成，基于对话中的代码分析结果整理 | Claude Sonnet 4.6 |
